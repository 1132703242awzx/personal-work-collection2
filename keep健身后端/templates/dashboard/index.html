{% extends "base.html" %}

{% block title %}ä»ªè¡¨ç›˜ - Keepå¥èº«{% endblock %}
{% block page_title %}æ•°æ®ä»ªè¡¨ç›˜{% endblock %}

{% block page_content %}
<!-- æ¬¢è¿ä¿¡æ¯ -->
<div class="row mb-4">
    <div class="col-12">
        <h2 class="mb-2">æ¬¢è¿å›æ¥, {{ current_user.nickname or current_user.username }}! ğŸ‘‹</h2>
        <p class="text-muted">è¿™æ˜¯æ‚¨çš„è¿åŠ¨æ•°æ®æ¦‚è§ˆ</p>
    </div>
</div>

<!-- ç»Ÿè®¡å¡ç‰‡ -->
<div class="row g-4 mb-4">
    <div class="col-md-3">
        <div class="stat-card" style="border-left-color: #4F46E5;">
            <div class="stat-card-icon text-primary">
                <i class="bi bi-calendar-check-fill"></i>
            </div>
            <div class="stat-card-label">æœ¬å‘¨è¿åŠ¨</div>
            <div class="stat-card-value text-primary">{{ stats.week_workouts }}</div>
            <small class="text-muted">æ¬¡</small>
        </div>
    </div>
    
    <div class="col-md-3">
        <div class="stat-card" style="border-left-color: #10B981;">
            <div class="stat-card-icon text-success">
                <i class="bi bi-fire"></i>
            </div>
            <div class="stat-card-label">æœ¬æœˆæ¶ˆè€—</div>
            <div class="stat-card-value text-success">{{ stats.month_calories }}</div>
            <small class="text-muted">åƒå¡</small>
        </div>
    </div>
    
    <div class="col-md-3">
        <div class="stat-card" style="border-left-color: #F59E0B;">
            <div class="stat-card-icon text-warning">
                <i class="bi bi-clock-fill"></i>
            </div>
            <div class="stat-card-label">æœ¬æœˆæ—¶é•¿</div>
            <div class="stat-card-value text-warning">{{ (stats.month_duration / 60) | round(1) }}</div>
            <small class="text-muted">å°æ—¶</small>
        </div>
    </div>
    
    <div class="col-md-3">
        <div class="stat-card" style="border-left-color: #06B6D4;">
            <div class="stat-card-icon text-info">
                <i class="bi bi-heart-pulse"></i>
            </div>
            <div class="stat-card-label">BMIæŒ‡æ•°</div>
            <div class="stat-card-value text-info">{{ stats.bmi or '-' }}</div>
            <small class="text-muted">{{ stats.weight or '-' }} kg</small>
        </div>
    </div>
</div>

<!-- å›¾è¡¨åŒºåŸŸ -->
<div class="row g-4 mb-4">
    <div class="col-lg-8">
        <div class="chart-container">
            <h5 class="mb-4"><i class="bi bi-graph-up"></i> è¿‘30å¤©è¿åŠ¨è¶‹åŠ¿</h5>
            <canvas id="workoutTrendChart" height="80"></canvas>
        </div>
    </div>
    
    <div class="col-lg-4">
        <div class="chart-container">
            <h5 class="mb-4"><i class="bi bi-pie-chart-fill"></i> è¿åŠ¨ç±»å‹åˆ†å¸ƒ</h5>
            <canvas id="workoutTypeChart"></canvas>
        </div>
    </div>
</div>

<!-- æ•°æ®è¡¨æ ¼ -->
<div class="row g-4">
    <div class="col-lg-8">
        <div class="data-table">
            <div class="table-header">
                <h5 class="mb-0"><i class="bi bi-list-ul"></i> æœ€è¿‘è¿åŠ¨è®°å½•</h5>
            </div>
            {% if recent_workouts %}
            <div class="table-responsive">
                <table class="table table-hover mb-0">
                    <thead class="table-light">
                        <tr>
                            <th>æ—¥æœŸ</th>
                            <th>è¿åŠ¨ç±»å‹</th>
                            <th>æ—¶é•¿</th>
                            <th>æ¶ˆè€—</th>
                            <th>éš¾åº¦</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for record in recent_workouts %}
                        <tr>
                            <td><i class="bi bi-calendar3"></i> {{ record.workout_date }}</td>
                            <td><strong>{{ record.workout_name or record.workout_type }}</strong></td>
                            <td><i class="bi bi-clock"></i> {{ record.duration }} åˆ†é’Ÿ</td>
                            <td><i class="bi bi-fire"></i> {{ record.calories or '-' }} åƒå¡</td>
                            <td>
                                {% if record.difficulty == 'easy' %}
                                <span class="badge bg-success">ç®€å•</span>
                                {% elif record.difficulty == 'medium' %}
                                <span class="badge bg-warning">ä¸­ç­‰</span>
                                {% elif record.difficulty == 'hard' %}
                                <span class="badge bg-danger">å›°éš¾</span>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            <div class="p-3 text-center">
                <a href="{{ url_for('workout.records') }}" class="btn btn-outline-primary">
                    æŸ¥çœ‹å…¨éƒ¨è®°å½• <i class="bi bi-arrow-right"></i>
                </a>
            </div>
            {% else %}
            <div class="text-center py-5">
                <i class="bi bi-inbox" style="font-size: 3rem; color: #D1D5DB;"></i>
                <p class="mt-3 text-muted">æš‚æ— è¿åŠ¨è®°å½•</p>
                <a href="{{ url_for('workout.add_record') }}" class="btn btn-primary">
                    <i class="bi bi-plus-circle"></i> æ·»åŠ ç¬¬ä¸€æ¡è®°å½•
                </a>
            </div>
            {% endif %}
        </div>
    </div>
    
    <div class="col-lg-4">
        <div class="data-table">
            <div class="table-header">
                <h5 class="mb-0"><i class="bi bi-person-bounding-box"></i> æœ€æ–°èº«ä½“æ•°æ®</h5>
            </div>
            <div class="p-4">
                {% if latest_body_record %}
                <dl class="row mb-0">
                    <dt class="col-6">è®°å½•æ—¥æœŸ:</dt>
                    <dd class="col-6">{{ latest_body_record.record_date }}</dd>
                    
                    <dt class="col-6">ä½“é‡:</dt>
                    <dd class="col-6"><strong>{{ latest_body_record.weight }} kg</strong></dd>
                    
                    {% if latest_body_record.body_fat %}
                    <dt class="col-6">ä½“è„‚ç‡:</dt>
                    <dd class="col-6">{{ latest_body_record.body_fat }}%</dd>
                    {% endif %}
                    
                    {% if current_user.height %}
                    <dt class="col-6">èº«é«˜:</dt>
                    <dd class="col-6">{{ current_user.height }} cm</dd>
                    {% endif %}
                    
                    {% if stats.bmi %}
                    <dt class="col-6">BMI:</dt>
                    <dd class="col-6">
                        <span class="badge {% if stats.bmi < 18.5 %}bg-info{% elif stats.bmi < 24 %}bg-success{% elif stats.bmi < 28 %}bg-warning{% else %}bg-danger{% endif %}">
                            {{ stats.bmi }}
                        </span>
                    </dd>
                    {% endif %}
                </dl>
                <a href="{{ url_for('workout.body_records') }}" class="btn btn-outline-primary w-100 mt-3">
                    æŸ¥çœ‹å†å²æ•°æ®
                </a>
                {% else %}
                <div class="text-center">
                    <i class="bi bi-inbox" style="font-size: 2rem; color: #D1D5DB;"></i>
                    <p class="mt-2 text-muted">æš‚æ— èº«ä½“æ•°æ®</p>
                    <a href="{{ url_for('workout.add_body_record') }}" class="btn btn-primary btn-sm">
                        æ·»åŠ æ•°æ®
                    </a>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// è¿åŠ¨è¶‹åŠ¿å›¾è¡¨
fetch('/analytics/api/workout-trend?days=30')
    .then(response => response.json())
    .then(data => {
        const ctx = document.getElementById('workoutTrendChart').getContext('2d');
        new Chart(ctx, {
            type: 'line',
            data: {
                labels: data.labels,
                datasets: [{
                    label: 'æ¶ˆè€—å¡è·¯é‡Œ',
                    data: data.calories,
                    borderColor: '#10B981',
                    backgroundColor: 'rgba(16, 185, 129, 0.1)',
                    tension: 0.4,
                    fill: true
                }, {
                    label: 'è¿åŠ¨æ—¶é•¿(åˆ†é’Ÿ)',
                    data: data.duration,
                    borderColor: '#F59E0B',
                    backgroundColor: 'rgba(245, 158, 11, 0.1)',
                    tension: 0.4,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    legend: {
                        position: 'top',
                    },
                    tooltip: {
                        mode: 'index',
                        intersect: false,
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        grid: {
                            color: 'rgba(0, 0, 0, 0.05)'
                        }
                    },
                    x: {
                        grid: {
                            display: false
                        }
                    }
                }
            }
        });
    });

// è¿åŠ¨ç±»å‹åˆ†å¸ƒå›¾è¡¨
fetch('/analytics/api/workout-type-distribution')
    .then(response => response.json())
    .then(data => {
        const ctx = document.getElementById('workoutTypeChart').getContext('2d');
        new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: data.labels,
                datasets: [{
                    data: data.data,
                    backgroundColor: [
                        '#4F46E5',
                        '#10B981',
                        '#F59E0B',
                        '#06B6D4',
                        '#8B5CF6',
                        '#EC4899'
                    ],
                    borderWidth: 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    legend: {
                        position: 'bottom',
                    }
                }
            }
        });
    });
</script>
{% endblock %}
