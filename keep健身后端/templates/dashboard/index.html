{% extends "base.html" %}

{% block title %}仪表盘 - Keep健身{% endblock %}
{% block page_title %}数据仪表盘{% endblock %}

{% block page_content %}
<!-- 欢迎信息 -->
<div class="row mb-4">
    <div class="col-12">
        <h2 class="mb-2">欢迎回来, {{ current_user.nickname or current_user.username }}! 👋</h2>
        <p class="text-muted">这是您的运动数据概览</p>
    </div>
</div>

<!-- 统计卡片 -->
<div class="row g-4 mb-4">
    <div class="col-md-3">
        <div class="stat-card" style="border-left-color: #4F46E5;">
            <div class="stat-card-icon text-primary">
                <i class="bi bi-calendar-check-fill"></i>
            </div>
            <div class="stat-card-label">本周运动</div>
            <div class="stat-card-value text-primary">{{ stats.week_workouts }}</div>
            <small class="text-muted">次</small>
        </div>
    </div>
    
    <div class="col-md-3">
        <div class="stat-card" style="border-left-color: #10B981;">
            <div class="stat-card-icon text-success">
                <i class="bi bi-fire"></i>
            </div>
            <div class="stat-card-label">本月消耗</div>
            <div class="stat-card-value text-success">{{ stats.month_calories }}</div>
            <small class="text-muted">千卡</small>
        </div>
    </div>
    
    <div class="col-md-3">
        <div class="stat-card" style="border-left-color: #F59E0B;">
            <div class="stat-card-icon text-warning">
                <i class="bi bi-clock-fill"></i>
            </div>
            <div class="stat-card-label">本月时长</div>
            <div class="stat-card-value text-warning">{{ (stats.month_duration / 60) | round(1) }}</div>
            <small class="text-muted">小时</small>
        </div>
    </div>
    
    <div class="col-md-3">
        <div class="stat-card" style="border-left-color: #06B6D4;">
            <div class="stat-card-icon text-info">
                <i class="bi bi-heart-pulse"></i>
            </div>
            <div class="stat-card-label">BMI指数</div>
            <div class="stat-card-value text-info">{{ stats.bmi or '-' }}</div>
            <small class="text-muted">{{ stats.weight or '-' }} kg</small>
        </div>
    </div>
</div>

<!-- 图表区域 -->
<div class="row g-4 mb-4">
    <div class="col-lg-8">
        <div class="chart-container">
            <h5 class="mb-4"><i class="bi bi-graph-up"></i> 近30天运动趋势</h5>
            <canvas id="workoutTrendChart" height="80"></canvas>
        </div>
    </div>
    
    <div class="col-lg-4">
        <div class="chart-container">
            <h5 class="mb-4"><i class="bi bi-pie-chart-fill"></i> 运动类型分布</h5>
            <canvas id="workoutTypeChart"></canvas>
        </div>
    </div>
</div>

<!-- 数据表格 -->
<div class="row g-4">
    <div class="col-lg-8">
        <div class="data-table">
            <div class="table-header">
                <h5 class="mb-0"><i class="bi bi-list-ul"></i> 最近运动记录</h5>
            </div>
            {% if recent_workouts %}
            <div class="table-responsive">
                <table class="table table-hover mb-0">
                    <thead class="table-light">
                        <tr>
                            <th>日期</th>
                            <th>运动类型</th>
                            <th>时长</th>
                            <th>消耗</th>
                            <th>难度</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for record in recent_workouts %}
                        <tr>
                            <td><i class="bi bi-calendar3"></i> {{ record.workout_date }}</td>
                            <td><strong>{{ record.workout_name or record.workout_type }}</strong></td>
                            <td><i class="bi bi-clock"></i> {{ record.duration }} 分钟</td>
                            <td><i class="bi bi-fire"></i> {{ record.calories or '-' }} 千卡</td>
                            <td>
                                {% if record.difficulty == 'easy' %}
                                <span class="badge bg-success">简单</span>
                                {% elif record.difficulty == 'medium' %}
                                <span class="badge bg-warning">中等</span>
                                {% elif record.difficulty == 'hard' %}
                                <span class="badge bg-danger">困难</span>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            <div class="p-3 text-center">
                <a href="{{ url_for('workout.records') }}" class="btn btn-outline-primary">
                    查看全部记录 <i class="bi bi-arrow-right"></i>
                </a>
            </div>
            {% else %}
            <div class="text-center py-5">
                <i class="bi bi-inbox" style="font-size: 3rem; color: #D1D5DB;"></i>
                <p class="mt-3 text-muted">暂无运动记录</p>
                <a href="{{ url_for('workout.add_record') }}" class="btn btn-primary">
                    <i class="bi bi-plus-circle"></i> 添加第一条记录
                </a>
            </div>
            {% endif %}
        </div>
    </div>
    
    <div class="col-lg-4">
        <div class="data-table">
            <div class="table-header">
                <h5 class="mb-0"><i class="bi bi-person-bounding-box"></i> 最新身体数据</h5>
            </div>
            <div class="p-4">
                {% if latest_body_record %}
                <dl class="row mb-0">
                    <dt class="col-6">记录日期:</dt>
                    <dd class="col-6">{{ latest_body_record.record_date }}</dd>
                    
                    <dt class="col-6">体重:</dt>
                    <dd class="col-6"><strong>{{ latest_body_record.weight }} kg</strong></dd>
                    
                    {% if latest_body_record.body_fat %}
                    <dt class="col-6">体脂率:</dt>
                    <dd class="col-6">{{ latest_body_record.body_fat }}%</dd>
                    {% endif %}
                    
                    {% if current_user.height %}
                    <dt class="col-6">身高:</dt>
                    <dd class="col-6">{{ current_user.height }} cm</dd>
                    {% endif %}
                    
                    {% if stats.bmi %}
                    <dt class="col-6">BMI:</dt>
                    <dd class="col-6">
                        <span class="badge {% if stats.bmi < 18.5 %}bg-info{% elif stats.bmi < 24 %}bg-success{% elif stats.bmi < 28 %}bg-warning{% else %}bg-danger{% endif %}">
                            {{ stats.bmi }}
                        </span>
                    </dd>
                    {% endif %}
                </dl>
                <a href="{{ url_for('workout.body_records') }}" class="btn btn-outline-primary w-100 mt-3">
                    查看历史数据
                </a>
                {% else %}
                <div class="text-center">
                    <i class="bi bi-inbox" style="font-size: 2rem; color: #D1D5DB;"></i>
                    <p class="mt-2 text-muted">暂无身体数据</p>
                    <a href="{{ url_for('workout.add_body_record') }}" class="btn btn-primary btn-sm">
                        添加数据
                    </a>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// 运动趋势图表
fetch('/analytics/api/workout-trend?days=30')
    .then(response => response.json())
    .then(data => {
        const ctx = document.getElementById('workoutTrendChart').getContext('2d');
        new Chart(ctx, {
            type: 'line',
            data: {
                labels: data.labels,
                datasets: [{
                    label: '消耗卡路里',
                    data: data.calories,
                    borderColor: '#10B981',
                    backgroundColor: 'rgba(16, 185, 129, 0.1)',
                    tension: 0.4,
                    fill: true
                }, {
                    label: '运动时长(分钟)',
                    data: data.duration,
                    borderColor: '#F59E0B',
                    backgroundColor: 'rgba(245, 158, 11, 0.1)',
                    tension: 0.4,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    legend: {
                        position: 'top',
                    },
                    tooltip: {
                        mode: 'index',
                        intersect: false,
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        grid: {
                            color: 'rgba(0, 0, 0, 0.05)'
                        }
                    },
                    x: {
                        grid: {
                            display: false
                        }
                    }
                }
            }
        });
    });

// 运动类型分布图表
fetch('/analytics/api/workout-type-distribution')
    .then(response => response.json())
    .then(data => {
        const ctx = document.getElementById('workoutTypeChart').getContext('2d');
        new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: data.labels,
                datasets: [{
                    data: data.data,
                    backgroundColor: [
                        '#4F46E5',
                        '#10B981',
                        '#F59E0B',
                        '#06B6D4',
                        '#8B5CF6',
                        '#EC4899'
                    ],
                    borderWidth: 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    legend: {
                        position: 'bottom',
                    }
                }
            }
        });
    });
</script>
{% endblock %}
